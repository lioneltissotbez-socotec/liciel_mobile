<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>LICIEL ‚Äì Saisie terrain</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LICIEL Mobile">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <meta name="description" content="Application terrain pour diagnostics immobiliers SOCOTEC">

  <!-- Styles globaux -->
  <link rel="stylesheet" href="style.css">

  <!-- Styles modules -->
  <link rel="stylesheet" href="modules/pieces/pieces.css">
  <link rel="stylesheet" href="modules/photos/photos.css">
  <link rel="stylesheet" href="modules/description/description.css">

</head>

<body>

<header id="app-header">
  <span id="header-title">D√©marrage mission</span>
</header>

<main>

  <!-- √âcran d√©marrage -->
  <section class="screen active" id="screen-start">
    <!-- Barre de chargement -->
    <div id="loading-bar" class="loading-container">
      <h2>Chargement de l'application...</h2>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <p id="loading-status" class="loading-status">Initialisation...</p>
    </div>
    
    <!-- Contenu principal (masqu√© au d√©marrage) -->
    <div id="start-content" class="start-content" style="display: none;">
      <h2>Nouvelle mission</h2>

      <label>Num√©ro de dossier</label>
      <input id="input-dossier" placeholder="Ex : 2512CGEDI" autocomplete="off">

      <button class="primary" onclick="startMission()">D√©marrer la mission</button>

      <h3>Missions existantes</h3>
      <div id="missions-list"></div>
      
      <button class="secondary" onclick="openArchiveManager()" style="margin-top: 20px;">
        ‚öôÔ∏è Gestion des donn√©es
      </button>
    </div>
  </section>

  <!-- √âcran pi√®ces -->
  <section class="screen" id="screen-pieces"></section>

  <!-- √âcran description de pi√®ce -->
<section class="screen" id="screen-description"></section>

  <!-- √âcran photos -->
  <section class="screen" id="screen-photos"></section>

</main>

<footer id="app-footer">
  <button onclick="go('start')">üè†</button>
  <button onclick="go('pieces')">üö™</button>
  <button onclick="go('photos')">üì∑</button>
</footer>

<!-- Core -->


<script src="core/store.js"></script>
<script src="core/db.js"></script>
<script src="core/migrations.js"></script>
<script src="core/photo-compressor.js"></script>
<script src="core/archive-manager.js"></script>
<script src="core/utils.js"></script>

<!-- ZIP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- EXPORT -->
<script src="modules/export/export.utils.js"></script>
<script src="modules/export/export.pieces.js"></script>
<script src="modules/export/export.photos.js"></script>
<script src="modules/export/export.description.js"></script>
<script src="modules/export/export.zip.js"></script>

<!-- Modules -->
<script src="modules/pieces/pieces.model.js"></script>
<script src="modules/pieces/pieces.ui.js"></script>

<script src="modules/description/description.ui.js"></script>

<script src="modules/photos/photos.ui.js"></script>

<!-- Dictionnaires -->
<script src="core/dictionnaires.js"></script>
<script src="core/dictionnaires_description.js"></script>

<script src="core/plomb.rules.js"></script>

<!-- App (TOUJOURS EN DERNIER) -->
<script src="app.js"></script>

<!-- Service Worker Registration -->
<script>
  // Enregistrement du Service Worker pour PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((registration) => {
          console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
          
          // V√©rifier les mises √† jour
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            console.log('üîÑ Mise √† jour du Service Worker d√©tect√©e');
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // Nouvelle version disponible
                console.log('‚ú® Nouvelle version disponible');
                
                // Afficher un message discret au lieu d'une alerte
                showUpdateNotification(newWorker);
              }
            });
          });
        })
        .catch((error) => {
          console.error('‚ùå Erreur Service Worker:', error);
        });
    });
    
    // Fonction pour afficher une notification de mise √† jour
    function showUpdateNotification(newWorker) {
      // Cr√©er une notification discr√®te
      const notification = document.createElement('div');
      notification.className = 'update-notification';
      notification.innerHTML = `
        <div class="update-content">
          <span>‚ú® Nouvelle version disponible</span>
          <button onclick="applyUpdate()">Mettre √† jour</button>
          <button onclick="this.parentElement.parentElement.remove()">Plus tard</button>
        </div>
      `;
      document.body.appendChild(notification);
      
      // Fonction pour appliquer la mise √† jour
      window.applyUpdate = () => {
        newWorker.postMessage({ type: 'SKIP_WAITING' });
        notification.remove();
      };
    }
    
    // Recharger quand le nouveau SW prend le contr√¥le
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) {
        refreshing = true;
        window.location.reload();
      }
    });
  }
</script>


</body>
</html>
